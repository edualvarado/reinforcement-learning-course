import unittest
import numpy as np
from blackjack import BlackjackEnv
from mc_evaluation import mc_evaluation

class TestMCEvaluation(unittest.TestCase):
  def setUp(self):
    self.sample_policy = lambda observation: 0 if observation[0] >= 20 else 1
    self.env = BlackjackEnv(test=True)

  def test_early_evaluation(self):
    expected_V_10k = {(14, 10, False): -0.638676844783715,
                      (20, 10, False): 0.4565972222222222,
                      (19, 10, False): -0.7610062893081762,
                      (20, 3, True): 0.6666666666666666,
                      (17, 3, True): -0.8571428571428571,
                      (15, 3, True): -0.5555555555555556,
                      (17, 5, False): -0.5096153846153846,
                      (21, 10, True): 0.8918918918918919,
                      (15, 4, False): -0.6,
                      (20, 4, False): 0.6225165562913907,
                      (13, 10, False): -0.6410256410256411,
                      (18, 10, False): -0.7287784679089027,
                      (21, 4, False): 0.88,
                      (16, 5, False): -0.6836734693877551,
                      (20, 2, False): 0.6625766871165644,
                      (15, 10, False): -0.6810126582278481,
                      (21, 5, False): 0.8876404494382022,
                      (14, 5, False): -0.6666666666666666,
                      (18, 10, True): -0.5254237288135594,
                      (16, 10, False): -0.7317073170731707,
                      (18, 8, False): -0.7297297297297297,
                      (20, 1, False): 0.1696969696969697,
                      (19, 6, False): -0.6470588235294118,
                      (20, 3, False): 0.6597222222222222,
                      (21, 10, False): 0.89198606271777,
                      (19, 10, True): -0.3492063492063492,
                      (18, 4, False): -0.6756756756756757,
                      (19, 5, False): -0.6542056074766355,
                      (12, 9, False): -0.5116279069767442,
                      (17, 3, False): -0.6571428571428571,
                      (15, 3, False): -0.6464646464646465,
                      (21, 3, False): 0.8651685393258427,
                      (18, 6, False): -0.5681818181818182,
                      (16, 6, False): -0.5504587155963303,
                      (13, 9, False): -0.44,
                      (14, 9, False): -0.5494505494505495,
                      (16, 9, False): -0.6851851851851852,
                      (18, 5, False): -0.7192982456140351,
                      (16, 4, False): -0.6307692307692307,
                      (21, 2, False): 0.8205128205128205,
                      (17, 7, False): -0.7333333333333333,
                      (16, 8, False): -0.6947368421052632,
                      (21, 1, True): 0.6363636363636364,
                      (16, 3, False): -0.72,
                      (18, 3, False): -0.7614678899082569,
                      (15, 4, True): -0.13333333333333333,
                      (19, 4, True): -0.7619047619047619,
                      (18, 7, False): -0.5876288659793815,
                      (16, 7, False): -0.7037037037037037,
                      (18, 2, False): -0.7350427350427351,
                      (16, 1, False): -0.6509433962264151,
                      (12, 1, False): -0.648936170212766,
                      (20, 8, False): 0.8456375838926175,
                      (19, 2, False): -0.6982758620689655,
                      (16, 2, False): -0.6486486486486487,
                      (15, 2, False): -0.7222222222222222,
                      (21, 7, False): 0.9431818181818182,
                      (20, 7, False): 0.8169014084507042,
                      (17, 8, False): -0.7087378640776699,
                      (21, 8, False): 0.9354838709677419,
                      (20, 6, False): 0.6347305389221557,
                      (14, 1, False): -0.6990291262135923,
                      (18, 1, False): -0.8285714285714286,
                      (21, 1, False): 0.589041095890411,
                      (15, 1, False): -0.64,
                      (13, 5, False): -0.5625,
                      (17, 10, False): -0.6997518610421837,
                      (19, 3, False): -0.7016129032258065,
                      (14, 2, False): -0.5727272727272728,
                      (18, 9, False): -0.5370370370370371,
                      (21, 9, False): 0.8194444444444444,
                      (15, 9, False): -0.5274725274725275,
                      (12, 2, False): -0.504950495049505,
                      (15, 6, False): -0.4690265486725664,
                      (15, 8, False): -0.5252525252525253,
                      (16, 3, True): 0.058823529411764705,
                      (19, 1, False): -0.7711864406779662,
                      (12, 5, False): -0.5858585858585859,
                      (18, 9, True): 0.0,
                      (20, 9, False): 0.7735849056603774,
                      (19, 2, True): -0.45454545454545453,
                      (12, 8, False): -0.5352112676056338,
                      (12, 10, False): -0.5949720670391061,
                      (12, 6, False): -0.5729166666666666,
                      (13, 6, False): -0.5643564356435643,
                      (12, 4, True): -1.0,
                      (14, 7, False): -0.5462962962962963,
                      (21, 8, True): 0.9454545454545454,
                      (20, 7, True): 0.7727272727272727,
                      (20, 1, True): -0.17391304347826086,
                      (15, 5, False): -0.6477272727272727,
                      (12, 4, False): -0.575,
                      (17, 4, False): -0.6,
                      (13, 7, False): -0.5617977528089888,
                      (16, 10, True): -0.4,
                      (12, 7, False): -0.42696629213483145,
                      (13, 2, False): -0.6732673267326733,
                      (20, 4, True): 0.6875,
                      (19, 9, False): -0.6938775510204082,
                      (14, 3, False): -0.5729166666666666,
                      (15, 2, True): 0.0,
                      (20, 2, True): 0.6111111111111112,
                      (19, 6, True): -0.3333333333333333,
                      (16, 6, True): -0.5833333333333334,
                      (21, 9, True): 0.9607843137254902,
                      (16, 4, True): -0.3,
                      (14, 6, False): -0.5,
                      (18, 2, True): -0.5714285714285714,
                      (13, 4, False): -0.5851063829787234,
                      (17, 1, False): -0.7415730337078652,
                      (16, 2, True): -0.35294117647058826,
                      (17, 9, False): -0.719626168224299,
                      (17, 6, False): -0.7029702970297029,
                      (15, 10, True): -0.24489795918367346,
                      (13, 3, False): -0.6222222222222222,
                      (21, 3, True): 0.9473684210526315,
                      (19, 4, False): -0.7102803738317757,
                      (19, 7, False): -0.75,
                      (15, 7, False): -0.5268817204301075,
                      (19, 8, True): -0.3333333333333333,
                      (19, 8, False): -0.7961165048543689,
                      (16, 8, True): -0.5294117647058824,
                      (13, 8, False): -0.6304347826086957,
                      (12, 10, True): -0.55,
                      (17, 5, True): -0.4444444444444444,
                      (13, 1, False): -0.6702127659574468,
                      (13, 4, True): -0.3333333333333333,
                      (19, 9, True): -0.0625,
                      (14, 8, False): -0.6190476190476191,
                      (12, 3, False): -0.5638297872340425,
                      (14, 1, True): -0.1,
                      (17, 2, False): -0.6638655462184874,
                      (21, 6, False): 0.875,
                      (14, 4, False): -0.6041666666666666,
                      (15, 5, True): -0.2857142857142857,
                      (12, 9, True): -0.42857142857142855,
                      (13, 9, True): -0.2222222222222222,
                      (20, 5, False): 0.635593220338983,
                      (21, 4, True): 0.92,
                      (14, 6, True): 0.2,
                      (15, 6, True): -0.17647058823529413,
                      (13, 7, True): 0.1,
                      (19, 7, True): -0.5,
                      (19, 1, True): -0.47058823529411764,
                      (16, 1, True): -0.125,
                      (17, 8, True): -0.38461538461538464,
                      (16, 5, True): -0.2727272727272727,
                      (19, 5, True): -0.5294117647058824,
                      (14, 10, True): -0.45,
                      (21, 7, True): 0.9807692307692307,
                      (18, 6, True): -0.5,
                      (14, 7, True): -0.1111111111111111,
                      (18, 4, True): -0.21052631578947367,
                      (12, 5, True): -1.0,
                      (13, 6, True): -0.5,
                      (21, 6, True): 0.9024390243902439,
                      (18, 5, True): -0.7142857142857143,
                      (15, 7, True): -0.1111111111111111,
                      (16, 7, True): -0.23076923076923078,
                      (20, 8, True): 0.875,
                      (20, 6, True): 0.9411764705882353,
                      (13, 2, True): -0.2,
                      (15, 8, True): -0.4,
                      (21, 2, True): 0.9069767441860465,
                      (17, 1, True): -0.5333333333333333,
                      (18, 7, True): 0.0,
                      (20, 9, True): 0.9473684210526315,
                      (17, 9, True): -0.7,
                      (13, 8, True): -0.42857142857142855,
                      (18, 1, True): -0.8666666666666667,
                      (20, 10, True): 0.6133333333333333,
                      (17, 7, True): -0.05263157894736842,
                      (17, 10, True): -0.546875,
                      (13, 5, True): -0.45454545454545453,
                      (18, 3, True): -0.16666666666666666,
                      (16, 9, True): -0.75,
                      (14, 9, True): 0.0,
                      (20, 5, True): 0.7222222222222222,
                      (12, 2, True): 0.0,
                      (17, 2, True): -0.17647058823529413,
                      (17, 6, True): -0.47058823529411764,
                      (18, 8, True): -0.35714285714285715,
                      (21, 5, True): 0.9047619047619048,
                      (15, 1, True): -0.6363636363636364,
                      (13, 3, True): -0.25,
                      (14, 2, True): -0.5454545454545454,
                      (14, 3, True): 0.0,
                      (14, 5, True): -0.6363636363636364,
                      (13, 10, True): -0.7058823529411765,
                      (15, 9, True): -0.21428571428571427,
                      (12, 3, True): -0.6,
                      (19, 3, True): -0.3,
                      (13, 1, True): -0.2,
                      (12, 1, True): -0.3333333333333333,
                      (17, 4, True): -0.36363636363636365,
                      (14, 8, True): -0.5,
                      (14, 4, True): -0.25,
                      (12, 7, True): -0.5,
                      (12, 8, True): -0.3333333333333333,
                      (12, 6, True): 1.0}
    V_10k = mc_evaluation(self.sample_policy, self.env, num_episodes=10000)
    self.assert_float_dict_almost_equal(expected_V_10k, V_10k, decimal=2)

  def test_late_evaluation(self):
    expected_V_500k = {(14, 10, False): -0.6330726604174219,
                       (20, 10, False): 0.43115252312727514,
                       (19, 10, False): -0.7410782080485953,
                       (20, 3, True): 0.6740139211136891,
                       (17, 3, True): -0.42857142857142855,
                       (15, 3, True): -0.3169877408056042,
                       (17, 5, False): -0.6773343373493976,
                       (21, 10, True): 0.8873119197524277,
                       (15, 4, False): -0.6310150009740892,
                       (20, 4, False): 0.6634590377113134,
                       (13, 10, False): -0.6030441238862961,
                       (18, 10, False): -0.7230409034568241,
                       (21, 4, False): 0.8924017003188098,
                       (16, 5, False): -0.6710681907765077,
                       (20, 2, False): 0.6461414358698575,
                       (15, 10, False): -0.6470942789693104,
                       (21, 5, False): 0.8885653785071467,
                       (14, 5, False): -0.6137533456866379,
                       (18, 10, True): -0.4557867360208062,
                       (16, 10, False): -0.6894347240915208,
                       (18, 8, False): -0.6915084199211752,
                       (20, 1, False): 0.14801255230125523,
                       (19, 6, False): -0.7286459269915483,
                       (20, 3, False): 0.6594953519256308,
                       (21, 10, False): 0.8874568769120614,
                       (19, 10, True): -0.4879951980792317,
                       (18, 4, False): -0.7207041995231982,
                       (19, 5, False): -0.7397309417040359,
                       (12, 9, False): -0.5169638973466725,
                       (17, 3, False): -0.6737015966232336,
                       (15, 3, False): -0.6360929124478857,
                       (21, 3, False): 0.883893149960328,
                       (18, 6, False): -0.7025069637883008,
                       (16, 6, False): -0.6687561214495592,
                       (13, 9, False): -0.5389133627019089,
                       (14, 9, False): -0.591326105087573,
                       (16, 9, False): -0.6382618510158014,
                       (18, 5, False): -0.6938629450706746,
                       (16, 4, False): -0.6698022653100403,
                       (21, 2, False): 0.8805563130624489,
                       (17, 7, False): -0.6756498470948012,
                       (16, 8, False): -0.6368747576580069,
                       (21, 1, True): 0.6413502109704642,
                       (16, 3, False): -0.6523172387046733,
                       (18, 3, False): -0.7209607806342654,
                       (15, 4, True): -0.3493975903614458,
                       (19, 4, True): -0.3900226757369615,
                       (18, 7, False): -0.6754834002188982,
                       (16, 7, False): -0.6286050618010595,
                       (18, 2, False): -0.7065779748706578,
                       (16, 1, False): -0.731721583154611,
                       (12, 1, False): -0.6322860238353196,
                       (20, 8, False): 0.7948141288530229,
                       (19, 2, False): -0.7253661182426324,
                       (16, 2, False): -0.66993006993007,
                       (15, 2, False): -0.6621915103652517,
                       (21, 7, False): 0.9268743400211193,
                       (20, 7, False): 0.7788091765017903,
                       (17, 8, False): -0.6579541180895073,
                       (21, 8, False): 0.9316170555108608,
                       (20, 6, False): 0.7086038961038961,
                       (14, 1, False): -0.7147195788621178,
                       (18, 1, False): -0.7743958679210478,
                       (21, 1, False): 0.6306425916091344,
                       (15, 1, False): -0.7114107466291004,
                       (13, 5, False): -0.579924082665542,
                       (17, 10, False): -0.7026433775453017,
                       (19, 3, False): -0.72,
                       (14, 2, False): -0.6168709744442136,
                       (18, 9, False): -0.69108049311095,
                       (21, 9, False): 0.941501976284585,
                       (15, 9, False): -0.6256186893684419,
                       (12, 2, False): -0.5546218487394958,
                       (15, 6, False): -0.6198102016607354,
                       (15, 8, False): -0.6036985484191688,
                       (16, 3, True): -0.35453100158982515,
                       (19, 1, False): -0.7785247093023255,
                       (12, 5, False): -0.5467511885895404,
                       (18, 9, True): -0.40100250626566414,
                       (20, 9, False): 0.7486574983628029,
                       (19, 2, True): -0.46402877697841727,
                       (12, 8, False): -0.523306948109059,
                       (12, 10, False): -0.5756062767475035,
                       (12, 6, False): -0.5523788251060978,
                       (13, 6, False): -0.5720940080457336,
                       (12, 4, True): -0.225531914893617,
                       (14, 7, False): -0.573907717435688,
                       (21, 8, True): 0.9320222317229585,
                       (20, 7, True): 0.7736670293797606,
                       (20, 1, True): 0.1684549356223176,
                       (15, 5, False): -0.6359959555106168,
                       (12, 4, False): -0.531236251649802,
                       (17, 4, False): -0.6884306987399771,
                       (13, 7, False): -0.5674872665534805,
                       (16, 10, True): -0.38412189254210105,
                       (12, 7, False): -0.5220883534136547,
                       (13, 2, False): -0.587116299178556,
                       (20, 4, True): 0.6707726763717805,
                       (19, 9, False): -0.729957805907173,
                       (14, 3, False): -0.5917111202297908,
                       (15, 2, True): -0.27106227106227104,
                       (20, 2, True): 0.626,
                       (19, 6, True): -0.4489281210592686,
                       (16, 6, True): -0.3579638752052545,
                       (21, 9, True): 0.9380952380952381,
                       (16, 4, True): -0.3027950310559006,
                       (14, 6, False): -0.6028484231943032,
                       (18, 2, True): -0.4493333333333333,
                       (13, 4, False): -0.5647108663418767,
                       (17, 1, False): -0.7420364573743325,
                       (16, 2, True): -0.3878887070376432,
                       (17, 9, False): -0.6705345253947118,
                       (17, 6, False): -0.6711941143180532,
                       (15, 10, True): -0.3622333182024512,
                       (13, 3, False): -0.5724123539232053,
                       (21, 3, True): 0.8908465835840138,
                       (19, 4, False): -0.7269155206286837,
                       (19, 7, False): -0.7129090909090909,
                       (15, 7, False): -0.6085817888799355,
                       (19, 8, True): -0.4160919540229885,
                       (19, 8, False): -0.7270412802327696,
                       (16, 8, True): -0.2951096121416526,
                       (13, 8, False): -0.5637860082304527,
                       (12, 10, True): -0.28376844494892167,
                       (17, 5, True): -0.42584434654919234,
                       (13, 1, False): -0.6630044369321784,
                       (13, 4, True): -0.2809917355371901,
                       (19, 9, True): -0.43427230046948356,
                       (14, 8, False): -0.584070796460177,
                       (12, 3, False): -0.546772068511199,
                       (14, 1, True): -0.3724770642201835,
                       (17, 2, False): -0.6978524743230625,
                       (21, 6, False): 0.901178361006963,
                       (14, 4, False): -0.590232655627751,
                       (15, 5, True): -0.3882149046793761,
                       (12, 9, True): -0.19130434782608696,
                       (13, 9, True): -0.29004329004329005,
                       (20, 5, False): 0.664389982590063,
                       (21, 4, True): 0.8913890090869754,
                       (14, 6, True): -0.30131004366812225,
                       (15, 6, True): -0.30927835051546393,
                       (13, 7, True): -0.22755741127348644,
                       (19, 7, True): -0.40526976160602257,
                       (19, 1, True): -0.5504151838671412,
                       (16, 1, True): -0.5560897435897436,
                       (17, 8, True): -0.36277173913043476,
                       (16, 5, True): -0.37237237237237236,
                       (19, 5, True): -0.47245017584994137,
                       (14, 10, True): -0.3586206896551724,
                       (21, 7, True): 0.9247454625940682,
                       (18, 6, True): -0.4785522788203753,
                       (14, 7, True): -0.2697495183044316,
                       (18, 4, True): -0.4076517150395778,
                       (12, 5, True): -0.21621621621621623,
                       (13, 6, True): -0.27631578947368424,
                       (21, 6, True): 0.9070074922873512,
                       (18, 5, True): -0.39315068493150684,
                       (15, 7, True): -0.28623853211009176,
                       (16, 7, True): -0.3419773095623987,
                       (20, 8, True): 0.7661122661122661,
                       (20, 6, True): 0.6954206602768903,
                       (13, 2, True): -0.3111587982832618,
                       (15, 8, True): -0.3528368794326241,
                       (21, 2, True): 0.8835978835978836,
                       (17, 1, True): -0.5085470085470085,
                       (18, 7, True): -0.37637362637362637,
                       (20, 9, True): 0.7583603020496225,
                       (17, 9, True): -0.3919523099850969,
                       (13, 8, True): -0.19246861924686193,
                       (18, 1, True): -0.5571955719557196,
                       (20, 10, True): 0.43856332703213613,
                       (17, 7, True): -0.3598265895953757,
                       (17, 10, True): -0.4348911880128434,
                       (13, 5, True): -0.25792811839323465,
                       (18, 3, True): -0.41948579161028415,
                       (16, 9, True): -0.35968992248062015,
                       (14, 9, True): -0.29080675422138835,
                       (20, 5, True): 0.6644219977553311,
                       (12, 2, True): -0.25112107623318386,
                       (17, 2, True): -0.40929535232383807,
                       (17, 6, True): -0.402002861230329,
                       (18, 8, True): -0.3885350318471338,
                       (21, 5, True): 0.8992963940193491,
                       (15, 1, True): -0.4964912280701754,
                       (13, 3, True): -0.32409381663113007,
                       (14, 2, True): -0.39105058365758755,
                       (14, 3, True): -0.1859582542694497,
                       (14, 5, True): -0.326007326007326,
                       (13, 10, True): -0.2902727740607308,
                       (15, 9, True): -0.3213675213675214,
                       (12, 3, True): -0.3076923076923077,
                       (19, 3, True): -0.45690672963400236,
                       (13, 1, True): -0.47216494845360824,
                       (12, 1, True): -0.38427947598253276,
                       (17, 4, True): -0.341991341991342,
                       (14, 8, True): -0.258,
                       (14, 4, True): -0.31363636363636366,
                       (12, 7, True): -0.2672413793103448,
                       (12, 8, True): -0.09722222222222222,
                       (12, 6, True): -0.22330097087378642}
    V_500k = mc_evaluation(self.sample_policy, self.env, num_episodes=500000)
    self.assert_float_dict_almost_equal(expected_V_500k, V_500k, decimal=2)

  def assert_float_dict_almost_equal(self, a, b, decimal=6):
    for key_pair in zip(sorted(a), sorted(b)):
      self.assertTupleEqual(key_pair[0], key_pair[1])
      self.assertAlmostEqual(a[key_pair[0]], b[key_pair[1]], places=decimal)

if __name__ == '__main__':
  unittest.main()